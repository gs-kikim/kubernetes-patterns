# CSI 볼륨으로 Secret을 마운트하는 테스트 Pod
apiVersion: v1
kind: Pod
metadata:
  name: csi-test-pod
  namespace: csi-test
spec:
  serviceAccountName: csi-test-sa
  containers:
    - name: app
      image: busybox:1.36
      command: ["sh", "-c"]
      args:
        - |
          echo "=== CSI 마운트된 Secret 파일 확인 ==="
          echo "마운트된 파일 목록:"
          ls -la /mnt/secrets-store/
          echo ""
          echo "DB Username: $(cat /mnt/secrets-store/db-username)"
          echo "DB Password length: $(cat /mnt/secrets-store/db-password | wc -c)"
          echo ""
          echo "=== 환경변수로 사용 (syncSecret) ==="
          echo "ENV DB_USERNAME: $DB_USERNAME"
          echo ""
          echo "=== 테스트 완료 ==="
          sleep 3600
      volumeMounts:
        - name: secrets-store
          mountPath: "/mnt/secrets-store"
          readOnly: true
      env:
        # syncSecret으로 생성된 K8s Secret에서 가져오기
        - name: DB_USERNAME
          valueFrom:
            secretKeyRef:
              name: database-creds-synced
              key: username
              optional: true
  volumes:
    - name: secrets-store
      csi:
        driver: secrets-store.csi.k8s.io
        readOnly: true
        volumeAttributes:
          secretProviderClass: "vault-database"
