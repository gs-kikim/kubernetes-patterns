# Test: 프로덕션급 보안 설정
# 목적: 모든 보안 모범 사례를 적용한 실제 워크로드 예제
# 특징:
#   - runAsNonRoot: true
#   - readOnlyRootFilesystem: true
#   - capabilities drop: ALL
#   - seccompProfile: RuntimeDefault
#   - allowPrivilegeEscalation: false
#   - 리소스 제한 설정
# 사용 사례: 상태 비저장 웹 애플리케이션, API 서버

apiVersion: v1
kind: Pod
metadata:
  name: production-secure-app
  labels:
    test: integration
    scenario: production-ready
    app: secure-web-app
spec:
  securityContext:
    runAsUser: 1000
    runAsGroup: 1000
    fsGroup: 2000
    runAsNonRoot: true
    seccompProfile:
      type: RuntimeDefault

  containers:
  - name: web-app
    image: python:3.11-alpine
    command:
    - sh
    - -c
    - |
      echo "Starting production-grade secure application..."
      cd /tmp
      cat > app.py <<'EOF'
      from http.server import HTTPServer, BaseHTTPRequestHandler
      import json

      class Handler(BaseHTTPRequestHandler):
          def do_GET(self):
              self.send_response(200)
              self.send_header('Content-type', 'application/json')
              self.end_headers()
              response = {
                  'status': 'healthy',
                  'security': {
                      'runAsNonRoot': True,
                      'readOnlyRootFilesystem': True,
                      'capabilities': 'ALL dropped',
                      'seccomp': 'RuntimeDefault'
                  }
              }
              self.wfile.write(json.dumps(response, indent=2).encode())

      server = HTTPServer(('0.0.0.0', 8080), Handler)
      print('Server running on port 8080...')
      server.serve_forever()
      EOF

      python3 app.py

    ports:
    - containerPort: 8080
      protocol: TCP

    securityContext:
      allowPrivilegeEscalation: false
      readOnlyRootFilesystem: true
      capabilities:
        drop: ['ALL']

    volumeMounts:
    - name: tmp
      mountPath: /tmp
    - name: cache
      mountPath: /home/app/.cache

    resources:
      requests:
        memory: "64Mi"
        cpu: "100m"
      limits:
        memory: "128Mi"
        cpu: "200m"

    livenessProbe:
      httpGet:
        path: /
        port: 8080
      initialDelaySeconds: 5
      periodSeconds: 10

    readinessProbe:
      httpGet:
        path: /
        port: 8080
      initialDelaySeconds: 3
      periodSeconds: 5

  volumes:
  - name: tmp
    emptyDir: {}
  - name: cache
    emptyDir: {}
