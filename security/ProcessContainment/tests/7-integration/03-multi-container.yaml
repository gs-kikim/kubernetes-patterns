# Test: 멀티 컨테이너 Pod 보안
# 목적: 여러 컨테이너가 있는 Pod에서의 보안 설정 검증
# 패턴: Sidecar 패턴 (애플리케이션 + 로그 수집기)
# 특징: 각 컨테이너가 다른 보안 요구사항을 가질 수 있음

apiVersion: v1
kind: Pod
metadata:
  name: multi-container-secure
  labels:
    test: integration
    scenario: multi-container
spec:
  # Pod 수준 기본 보안 설정 (모든 컨테이너에 적용)
  securityContext:
    runAsNonRoot: true
    fsGroup: 3000
    seccompProfile:
      type: RuntimeDefault

  containers:
  # 메인 애플리케이션 컨테이너
  - name: app
    image: python:3.11-alpine
    command:
    - sh
    - -c
    - |
      echo "Starting application server..."
      cd /tmp
      cat > server.py <<'EOF'
      from http.server import HTTPServer, BaseHTTPRequestHandler
      import datetime

      class LogHandler(BaseHTTPRequestHandler):
          def do_GET(self):
              # 로그 작성
              with open('/shared/logs/access.log', 'a') as f:
                  f.write(f"{datetime.datetime.now()} - GET request from {self.client_address}\n")

              self.send_response(200)
              self.send_header('Content-type', 'text/plain')
              self.end_headers()
              self.wfile.write(b'Hello from secure multi-container pod!\n')

      server = HTTPServer(('0.0.0.0', 8080), LogHandler)
      print('App server running on port 8080...')
      server.serve_forever()
      EOF

      python3 server.py

    ports:
    - containerPort: 8080

    securityContext:
      runAsUser: 1000
      runAsGroup: 2000
      allowPrivilegeEscalation: false
      readOnlyRootFilesystem: true
      capabilities:
        drop: ['ALL']

    volumeMounts:
    - name: tmp
      mountPath: /tmp
    - name: shared-logs
      mountPath: /shared/logs

    resources:
      requests:
        memory: "64Mi"
        cpu: "100m"
      limits:
        memory: "128Mi"
        cpu: "200m"

  # Sidecar: 로그 수집기
  - name: log-collector
    image: busybox:1.36
    command:
    - sh
    - -c
    - |
      echo "Starting log collector sidecar..."
      echo "Watching /shared/logs/access.log"

      # 로그 파일이 생성될 때까지 대기
      while [ ! -f /shared/logs/access.log ]; do
        sleep 1
      done

      # 로그 파일 모니터링
      tail -f /shared/logs/access.log | while read line; do
        echo "[LOG COLLECTOR] $line"
      done

    securityContext:
      runAsUser: 2000
      runAsGroup: 3000
      allowPrivilegeEscalation: false
      capabilities:
        drop: ['ALL']

    volumeMounts:
    - name: shared-logs
      mountPath: /shared/logs
      readOnly: true  # 로그 수집기는 읽기 전용으로 마운트

    resources:
      requests:
        memory: "32Mi"
        cpu: "50m"
      limits:
        memory: "64Mi"
        cpu: "100m"

  volumes:
  - name: tmp
    emptyDir: {}
  - name: shared-logs
    emptyDir: {}
