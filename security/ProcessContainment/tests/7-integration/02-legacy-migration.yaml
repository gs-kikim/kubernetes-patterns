# Test: 레거시 앱 보안 마이그레이션
# 목적: init container를 통한 점진적 보안 강화 전략
# 전략: init container에서 root 권한 작업 수행 후, 앱 컨테이너는 non-root로 실행
# 사용 사례: 파일 권한 변경이 필요한 레거시 애플리케이션

apiVersion: v1
kind: Pod
metadata:
  name: legacy-app-secure
  labels:
    test: integration
    scenario: legacy-migration
spec:
  securityContext:
    fsGroup: 3000

  # Init Container: root 권한이 필요한 초기화 작업
  initContainers:
  - name: setup-permissions
    image: busybox:1.36
    command:
    - sh
    - -c
    - |
      echo "=== Init Container: Setting up permissions ==="
      # 볼륨 디렉토리 생성 및 권한 설정
      mkdir -p /data/app /data/logs /data/config
      chown -R 1000:2000 /data
      chmod -R 755 /data

      # 설정 파일 생성
      cat > /data/config/app.conf <<EOF
      # Application Configuration
      user=appuser
      group=appgroup
      log_dir=/data/logs
      data_dir=/data/app
      EOF

      echo "Initialization completed!"
      ls -la /data/
    securityContext:
      runAsUser: 0  # Init container만 root로 실행
      runAsNonRoot: false
    volumeMounts:
    - name: app-data
      mountPath: /data

  # Main Container: non-root로 실행
  containers:
  - name: app
    image: busybox:1.36
    command:
    - sh
    - -c
    - |
      echo "=== Application Container (non-root) ==="
      id
      echo ""
      echo "Checking data directory permissions:"
      ls -la /data/
      echo ""
      echo "Reading configuration:"
      cat /data/config/app.conf
      echo ""
      echo "Testing write access to data directory:"
      date > /data/app/startup.log
      cat /data/app/startup.log
      echo ""
      echo "Application is running securely as non-root user..."
      sleep 3600
    securityContext:
      runAsUser: 1000
      runAsGroup: 2000
      runAsNonRoot: true
      allowPrivilegeEscalation: false
      capabilities:
        drop: ['ALL']
    volumeMounts:
    - name: app-data
      mountPath: /data

  volumes:
  - name: app-data
    emptyDir: {}
