# JSON 형식으로 Secret을 렌더링하는 예시
apiVersion: apps/v1
kind: Deployment
metadata:
  name: vault-json-config
  namespace: vault-sidecar-test
spec:
  replicas: 1
  selector:
    matchLabels:
      app: vault-json-test
  template:
    metadata:
      labels:
        app: vault-json-test
      annotations:
        vault.hashicorp.com/agent-inject: "true"
        vault.hashicorp.com/role: "myapp"

        # JSON 형식으로 설정 파일 생성
        vault.hashicorp.com/agent-inject-secret-config.json: "secret/data/myapp"
        vault.hashicorp.com/agent-inject-template-config.json: |
          {{- with secret "secret/data/myapp" -}}
          {
            "database": {
              "username": "{{ .Data.data.username }}",
              "password": "{{ .Data.data.password }}"
            },
            "api": {
              "key": "{{ .Data.data.api_key }}"
            }
          }
          {{- end -}}
    spec:
      serviceAccountName: myapp-sa
      containers:
        - name: app
          image: busybox:1.36
          command: ["sh", "-c"]
          args:
            - |
              echo "=== JSON 형식 Secret 확인 ==="
              cat /vault/secrets/config.json
              echo ""
              sleep 3600
