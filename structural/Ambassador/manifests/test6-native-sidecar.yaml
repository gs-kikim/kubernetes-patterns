# Test 6: Native Sidecar 시작 순서 검증
# Kubernetes 1.28+ 의 Native Sidecar 기능 사용
# initContainers에 restartPolicy: Always를 설정하여 Native Sidecar로 동작

apiVersion: v1
kind: ConfigMap
metadata:
  name: startup-logger-config
  labels:
    test: ambassador-native-sidecar
data:
  log-startup.sh: |
    #!/bin/sh
    echo "[$(date -Iseconds)] Container '$CONTAINER_NAME' starting..."
    echo "[$(date -Iseconds)] Container '$CONTAINER_NAME' is ready!"

---
apiVersion: v1
kind: Pod
metadata:
  name: native-sidecar-test
  labels:
    test: ambassador-native-sidecar
spec:
  # 일반 Init Container (한 번만 실행되고 종료)
  initContainers:
  # 1. 일반 init container
  - name: init-setup
    image: busybox:1.36
    command:
    - "/bin/sh"
    - "-c"
    - |
      echo "[$(date -Iseconds)] [INIT] Running one-time initialization..."
      sleep 2
      echo "[$(date -Iseconds)] [INIT] Initialization complete!"
    env:
    - name: CONTAINER_NAME
      value: "init-setup"

  # 2. Native Sidecar (restartPolicy: Always)
  # Ambassador로 동작하며, 메인 컨테이너보다 먼저 시작됨
  - name: ambassador-sidecar
    image: hashicorp/http-echo:1.0
    restartPolicy: Always  # 이것이 Native Sidecar의 핵심!
    args:
    - "-listen=:8080"
    - "-text=Native Sidecar Ambassador is running"
    ports:
    - containerPort: 8080
    # startupProbe: 메인 컨테이너는 이 Probe가 성공할 때까지 시작되지 않음
    startupProbe:
      httpGet:
        path: /
        port: 8080
      initialDelaySeconds: 2
      periodSeconds: 2
      failureThreshold: 5
    livenessProbe:
      httpGet:
        path: /
        port: 8080
      periodSeconds: 10
    env:
    - name: CONTAINER_NAME
      value: "ambassador-sidecar"
    resources:
      requests:
        memory: "32Mi"
        cpu: "50m"

  # 메인 컨테이너들 (Native Sidecar가 준비된 후에만 시작됨)
  containers:
  - name: main-app
    image: curlimages/curl:8.5.0
    command:
    - "/bin/sh"
    - "-c"
    - |
      echo "[$(date -Iseconds)] [MAIN] Main application starting..."
      echo "[$(date -Iseconds)] [MAIN] Native Sidecar should already be running!"
      echo ""

      # Ambassador가 이미 준비되어 있어야 함
      echo "[$(date -Iseconds)] [MAIN] Testing immediate connection to Ambassador..."
      if curl -s http://localhost:8080; then
        echo ""
        echo "[$(date -Iseconds)] [MAIN] ✓ SUCCESS: Ambassador was ready before main started!"
      else
        echo ""
        echo "[$(date -Iseconds)] [MAIN] ✗ FAILED: Ambassador not ready (shouldn't happen with Native Sidecar)"
      fi
      echo ""

      # 계속 실행
      counter=1
      while [ $counter -le 10 ]; do
        echo "[$(date -Iseconds)] [MAIN] Request #$counter to Ambassador..."
        curl -s http://localhost:8080
        echo ""
        sleep 5
        counter=$((counter + 1))
      done

      echo "[$(date -Iseconds)] [MAIN] Main application completed 10 iterations"
      echo "[$(date -Iseconds)] [MAIN] Exiting..."
    env:
    - name: CONTAINER_NAME
      value: "main-app"
    resources:
      requests:
        memory: "32Mi"
        cpu: "50m"

  # 로그 수집용 Sidecar (일반 컨테이너)
  - name: log-collector
    image: busybox:1.36
    command:
    - "/bin/sh"
    - "-c"
    - |
      echo "[$(date -Iseconds)] [LOG-COLLECTOR] Starting log collection..."
      while true; do
        echo "[$(date -Iseconds)] [LOG-COLLECTOR] Collecting logs..."
        sleep 15
      done
    env:
    - name: CONTAINER_NAME
      value: "log-collector"
    resources:
      requests:
        memory: "16Mi"
        cpu: "25m"
