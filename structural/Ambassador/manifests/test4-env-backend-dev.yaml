# Test 4: 환경별 백엔드 전환 - 개발 환경
# 개발 환경에서는 간단한 로컬 캐시(메모리) 사용

apiVersion: v1
kind: ConfigMap
metadata:
  name: cache-config-dev
  labels:
    env: development
    test: ambassador-env-backend
data:
  backend: "local-memory"
  description: "Development environment using simple in-memory cache"

---
apiVersion: v1
kind: Pod
metadata:
  name: app-dev-env
  labels:
    env: development
    test: ambassador-env-backend
spec:
  containers:
  # 메인 애플리케이션 (환경에 무관하게 동일한 코드)
  - name: main
    image: redis:7-alpine
    command:
    - "/bin/sh"
    - "-c"
    - |
      echo "Application starting in DEVELOPMENT environment..."
      echo "Cache endpoint: localhost:6379"
      echo ""

      # Wait for ambassador
      sleep 3

      echo "Testing cache connection..."
      while true; do
        echo "=== $(date) ==="

        # SET command
        echo "Setting key: test-key-$(date +%s)"
        redis-cli -h localhost -p 6379 SET "test-key" "value-$(date +%s)" EX 30

        # GET command
        echo "Getting key: test-key"
        value=$(redis-cli -h localhost -p 6379 GET "test-key")
        echo "Value: $value"
        echo ""

        sleep 10
      done
    resources:
      requests:
        memory: "64Mi"
        cpu: "50m"

  # Ambassador - 개발 환경용 간단한 Redis (로컬 캐시 시뮬레이션)
  - name: ambassador
    image: redis:7-alpine
    command:
    - "redis-server"
    - "--port"
    - "6379"
    - "--maxmemory"
    - "32mb"
    - "--maxmemory-policy"
    - "allkeys-lru"
    ports:
    - containerPort: 6379
    env:
    - name: ENVIRONMENT
      valueFrom:
        configMapKeyRef:
          name: cache-config-dev
          key: backend
    resources:
      requests:
        memory: "32Mi"
        cpu: "50m"
      limits:
        memory: "64Mi"
        cpu: "100m"
